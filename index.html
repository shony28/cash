<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–≤—á–µ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—ó –≥—Ä–∞–º–∞—Ç–∏–∫–∏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7fcff;
            padding: 15px;
        }
        .sentence-container {
            margin: 20px 0;
        }
        .word {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            border: 1px solid #333;
            cursor: pointer;
            font-size: 30px; /* –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É –¥–ª—è —Å–ª—ñ–≤ */
            border-radius: 5px;
            background-color: white;
        }
        .word.clicked {
            background-color: lightgreen;
            border-color: green;
        }
        #feedback {
            margin-top: 20px;
        }
        #russian-sentence {
            font-size: 36px; /* –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É */
            font-weight: bold;
        }
        #check-btn, #reset-btn { /* –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ */
            font-size: 18px; /* –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É –∫–Ω–æ–ø–∫–∏ */
            padding: 10px 20px;
            margin-top: 20px;
            cursor: pointer;
            margin-right: 10px; /* –†–∞–∑–¥–µ–ª–∏—Ç—å –∫–Ω–æ–ø–∫–∏ */
        }
        #correct-answer {
            color: darkgreen; /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ */
            font-weight: bold;
            margin-top: 20px;
            font-size: 40px; /* –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ */
        }
        #feedback.incorrect {
            color: darkred; /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω–∏–π –∫–æ–ª—ñ—Ä */
            font-size: 20px;
        }
        h1 {
            font-size: 20px; /* –ó–º–µ–Ω—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫—É */
            color: #00000094; /* –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É –∑–∞–≥–æ–ª–æ–≤–∫—É */
            font-weight: lighter; /* –ó—Ä–æ–±–∏—Ç–∏ —à—Ä–∏—Ñ—Ç —Ç–æ–Ω—à–∏–º */
        }
        #name-input-container {
            margin-top: 20px;
        }
        #stats-container {
            margin-top: 20px;
            font-size: 16px; /* –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        }
        .separator {
            margin: 20px 0;
            border-bottom: 2px solid #9f9f9f;
        }
        .hidden {
            display: none;
        }
        .correct-count {
            color: darkgreen; /* –¢–µ–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ */
            font-weight: bold;
        }

        .incorrect-count {
            color: darkred; /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ */
            font-weight: bold;
        }

        .correct-after-incorrect-count {
            color: #cb8401; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ */
            font-weight: bold;
        }
        .correct-feedback {
            color: darkgreen; /* –¢–µ–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç */
            font-size: 20px;
            font-weight: bold;
        }
        #name-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 20px;
        }

        #name-input-container label {
            font-size: 18px;
            margin-bottom: 10px;
        }

        #name-input {
            padding: 10px 15px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 80%; /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
            max-width: 300px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
            margin-bottom: 10px;
        }

        #start-btn {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #4CAF50; /* –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω */
            color: white; /* –ë–µ–ª—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            border: none;
            border-radius: 5px;
        }
        .styled-button {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #4CAF50; /* –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω */
            color: white; /* –ë–µ–ª—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            border: none;
            border-radius: 5px;
            margin-top: 20px;
            margin-right: 10px;
        }

    </style>
</head>
<body>
    <h1>–í–∏–≤—á–µ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—ó –≥—Ä–∞–º–∞—Ç–∏–∫–∏</h1>
    <div id="name-input-container">
        <label for="name-input">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è: </label>
        <input type="text" id="name-input">
        <button id="start-btn">–ü–æ—á–∞—Ç–∏</button>
    </div>

    <div class="separator hidden"></div> <!-- –õ–∏–Ω–∏—è –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è -->

    <div id="russian-sentence" class="hidden"></div>
    <div id="english-words-container" class="sentence-container hidden"></div>
    <button id="check-btn" class="hidden styled-button">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
    <button id="reset-btn" class="hidden styled-button"><i class="fas fa-redo"></i></button> <!-- —Å–∫–∏–Ω—É—Ç–∏ -->
    <div id="feedback" class="hidden"></div>
    <div id="correct-answer" class="hidden"></div>
    <div class="separator"></div> <!-- –õ–∏–Ω–∏—è –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è -->
    <div id="stats-container" class="hidden"></div>

    <script>
        const SPREADSHEET_ID = '1t4-Ds_1nlvX8ereG8xGfZ7khkocq5KkfyF5Em608h8U';
        const RANGE = '–ì—Ä–∞–º–∞—Ç–∏–∫–∞!A:C';
        const USERS_RANGE = 'users!A:B';
        const API_KEY = 'AIzaSyD-VNZ85_c09OXV9rPkBhHXbtDwXqsNZnM';
        const TELEGRAM_BOT_TOKEN = '6011167887:AAHf0yAGVoH4MFnuQdyP5PAk_iSgsVV4l2E';
        const TELEGRAM_CHAT_ID = '459773195';

        let correctAnswer = '';
        let userAnswer = [];
        let currentIndex = 0;
        let values = [];
        let userName = '';
        let correctAnswers = 0;
        let incorrectAnswers = 0;
        let correctAfterIncorrect = 0;
        let previousIncorrect = false;

        const fetchData = (sheetName) => {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}!A:C?key=${API_KEY}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    values = data.values.slice(1); // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    if (values.length > 0) {
                        loadQuestion(currentIndex);
                    }
                })
                .catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö:', err));
        };

        const fetchUserSheet = () => {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${USERS_RANGE}?key=${API_KEY}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const users = data.values.slice(1); // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    const user = users.find(row => row[0] === userName);
                    if (user) {
                        const userSheet = user[1];
                        fetchData(userSheet);
                    } else {
                        alert('–í–∞—Å –Ω–µ–º–∞—î –≤ —Å–∏—Å—Ç–µ–º—ñ. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                    }
                })
                .catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', err));
        };

               const loadQuestion = (index) => {
            const feedbackElement = document.getElementById('feedback');
            const russianSentence = values[index][0];
            correctAnswer = values[index][1];
            const distractors = values[index][2] ? values[index][2].split(' ') : [];
            userAnswer = [];
            feedbackElement.innerText = '';
            document.getElementById('correct-answer').innerText = '';

            document.getElementById('russian-sentence').innerText = russianSentence;

            const words = correctAnswer.split(' ').concat(distractors).sort(() => 0.5 - Math.random());
            const container = document.getElementById('english-words-container');
            container.innerHTML = '';
            words.forEach(word => {
                const span = document.createElement('span');
                span.innerText = word;
                span.className = 'word';
                span.onclick = () => {
                    if (!span.classList.contains('clicked')) {
                        userAnswer.push(word);
                        span.classList.add('clicked');
                    }
                };
                container.appendChild(span);
            });
        };

        const playAudio = (text) => {
            const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=en&q=${encodeURIComponent(text)}&client=tw-ob`;
            const audio = new Audio(audioUrl);
            audio.play();
        };

        document.getElementById('check-btn').onclick = () => {
            const userAnswerStr = userAnswer.join(' ');
            const feedbackElement = document.getElementById('feedback');
            const correctAnswerElement = document.getElementById('correct-answer');

            if (userAnswerStr === correctAnswer) {
                feedbackElement.innerText = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                feedbackElement.classList.remove('incorrect');
                feedbackElement.classList.add('correct-feedback');
                correctAnswerElement.innerText = correctAnswer;
                playAudio(correctAnswer);

                if (previousIncorrect) {
                    correctAfterIncorrect++;
                    previousIncorrect = false;
                } else {
                    correctAnswers++;
                }

                currentIndex++;

                if (currentIndex < values.length) {
                    setTimeout(() => {
                        correctAnswerElement.innerText = '';
                        loadQuestion(currentIndex);
                    }, 4000);
                } else {
                    document.getElementById('russian-sentence').classList.add('hidden');
                    document.getElementById('english-words-container').classList.add('hidden');
                    document.getElementById('check-btn').classList.add('hidden');
                    document.getElementById('reset-btn').classList.add('hidden');
                    document.getElementById('feedback').classList.add('hidden');
                    document.getElementById('correct-answer').classList.add('hidden');

                    feedbackElement.innerText = '–í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å—ñ –ø–∏—Ç–∞–Ω–Ω—è.';
                    feedbackElement.classList.remove('hidden');
                    document.getElementById('stats-container').classList.remove('hidden');
                    updateStats();
                    sendResultsToTelegram();
                }
            } else {
                feedbackElement.innerText = '–í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ. üò¢';
                feedbackElement.classList.add('incorrect');
                feedbackElement.classList.remove('correct-feedback');
                incorrectAnswers++;
                previousIncorrect = true;
                resetClickedWords();
            }
            updateStats();
        };

        document.getElementById('reset-btn').onclick = () => {
            resetClickedWords();
            loadQuestion(currentIndex);
        };

        const updateStats = () => {
            const statsElement = document.getElementById('stats-container');
            statsElement.innerHTML = `
                <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: <span class="correct-count">${correctAnswers}</span></p>
                <p>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: <span class="incorrect-count">${incorrectAnswers}</span></p>
                <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–∫–∏: <span class="correct-after-incorrect-count">${correctAfterIncorrect}</span></p>`;
            statsElement.classList.remove('hidden');
        };

        document.getElementById('start-btn').onclick = () => {
            userName = document.getElementById('name-input').value;
            if (userName.trim()) {
                document.getElementById('name-input-container').style.display = 'none';
                document.querySelector('.separator').classList.remove('hidden');
                document.getElementById('russian-sentence').classList.remove('hidden');
                document.getElementById('english-words-container').classList.remove('hidden');
                document.getElementById('check-btn').classList.remove('hidden');
                document.getElementById('reset-btn').classList.remove('hidden');
                document.getElementById('feedback').classList.remove('hidden');
                document.getElementById('correct-answer').classList.remove('hidden');
                fetchUserSheet();
            } else {
                alert('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è.');
            }
        };

        const resetClickedWords = () => {
            const words = document.querySelectorAll('.word');
            words.forEach(word => word.classList.remove('clicked'));
            userAnswer = [];
        };

        const sendResultsToTelegram = () => {
            const message = `
                –Ü–º'—è: ${userName}\n
                –ü—Ä–∞–≤–∏–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: ${correctAnswers}\n
                –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: ${incorrectAnswers}\
                –ü—Ä–∞–≤–∏–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–∫–∏: ${correctAfterIncorrect}
            `;

            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        alert('–ú–æ–ª–æ–¥–µ—Ü—å! –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –£–ª—è–Ω—ñ –í–∞—Å–∏–ª—ñ–≤–Ω—ñ.');
                    } else {
                        alert('–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —É Telegram.');
                    }
                })
                .catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö —É Telegram:', err));
        };

                        if ('serviceWorker' in navigator) {
                  window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                      .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                      })
                      .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                      });
                  });
                }

    </script>
</body>
</html>